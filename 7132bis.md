---
title: convert everything to "struct proc_ops"ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ãŸã®ã§ã€Intel NUCã®LEDæ“ä½œç”¨ã®ãƒ‰ãƒ©ã‚¤ãƒã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã¦ã¿ãŸã€‚ - pandaå¤§å­¦ç¿’å¸³å¤–ä¼
description: ä¹…ã€…ã«Linuxã®ãƒ‰ãƒ©ã‚¤ãƒã®ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã£ã¦ã¿ã¾ã—ãŸã€‚
mathjax: true
image: https://pandanote.info/wordpress/wp-content/uploads/2021/01/P_20201231_102850_vHDR_On_HP-scaled.jpg
twitter: 
  card: summary_large_image
encoding: UTF-8
update: Sat Jan  2 15:47:14 2021 +0900
---
{% include pagelink.md %}
# convert everything to "struct proc_ops"ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ãŸã®ã§ã€Intel NUCã®LEDæ“ä½œç”¨ã®ãƒ‰ãƒ©ã‚¤ãƒã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã¦ã¿ãŸã€‚
{% if page.update %}æœ€çµ‚æ›´æ–°æ—¥: {{ page.update }} {% endif %}
## ã¯ã˜ã‚ã«
å‚è€ƒæ–‡çŒ®[2]ã®patchãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹Linuxã®kernelã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Intel NUCã®LEDæ“ä½œç”¨ã®ãƒ‰ãƒ©ã‚¤ãƒ(å‚è€ƒæ–‡çŒ®[1]ã€ä»¥ä¸‹å˜ã«ã€Œãƒ‰ãƒ©ã‚¤ãƒã€ã¨æ›¸ãã¾ã™ã€‚)ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ãƒ‰ãƒ©ã‚¤ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
{% include firstad.html %}
## ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®å†…å®¹
Fedora 33ã®kernel(5.9.16)ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãƒ‰ãƒ©ã‚¤ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒä¸­æ–­ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
```
[root@pandanote.info intel_nuc_led]# make -j4 KERNELRELEASE=5.9.16-200.fc33.x86_64 -C /lib/modules/5.9.16-200.fc33.x86_64/build M=/var/lib/dkms/intel-nuc-led/1.0/build
make: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '/usr/src/kernels/5.9.16-200.fc33.x86_64'ã€€ã«å…¥ã‚Šã¾ã™
  CC [M]  /var/lib/dkms/intel-nuc-led/1.0/build/nuc_led.o
/var/lib/dkms/intel-nuc-led/1.0/build/nuc_led.c: é–¢æ•° â€˜init_nuc_ledâ€™ å†…:
/var/lib/dkms/intel-nuc-led/1.0/build/nuc_led.c:475:75: ã‚¨ãƒ©ãƒ¼: äº’æ›æ€§ã®ãªã„ãƒã‚¤ãƒ³ã‚¿å‹ã‹ã‚‰ 4 ç•ªç›®ã® â€˜proc_createâ€™ ã®å¼•æ•°ã«æ¸¡ã—ã¦ã„ã¾ã™ [-Werror=incompatible-pointer-types]
  475 | ntry = proc_create("nuc_led", nuc_led_perms, acpi_root_dir, &proc_acpi_operations);
      |                                                             ^~~~~~~~~~~~~~~~~~~~~
      |                                                             |
      |                                                             struct file_operations *

æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿:  /var/lib/dkms/intel-nuc-led/1.0/build/nuc_led.c:36:
./include/linux/proc_fs.h:107:122: å‚™è€ƒ: expected â€˜const struct proc_ops *â€™ but argument is of type â€˜struct file_operations *â€™
  107 |  mode, struct proc_dir_entry *parent, const struct proc_ops *proc_ops);
      |                                       ~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~

cc1: ã„ãã¤ã‹ã®è­¦å‘Šã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å–ã‚Šæ‰±ã‚ã‚Œã¾ã™
make[1]: *** [scripts/Makefile.build:283: /var/lib/dkms/intel-nuc-led/1.0/build/nuc_led.o] ã‚¨ãƒ©ãƒ¼ 1
make: *** [Makefile:1787: /var/lib/dkms/intel-nuc-led/1.0/build] ã‚¨ãƒ©ãƒ¼ 2
make: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '/usr/src/kernels/5.9.16-200.fc33.x86_64' ã‹ã‚‰å‡ºã¾ã™
```
ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹é™ã‚Šã€proc_createé–¢æ•°ã®ç¬¬4å¼•æ•°ã®å‹ãŒåˆã‚ãªã„ã“ã¨ãŒåŸå› ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«å¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
## ä½œæ¥­ã®æ–¹é‡
kernelã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(proc_fs.h)ã‚’è¦‹ã‚‹é™ã‚Šã§ã¯ã€proc_createé–¢æ•°ã®å¼•æ•°ã®ã†ã¡ç¬¬4å¼•æ•°ã®å‹ãŒproc_opså‹ã®æ§‹é€ ä½“(ã¸ã®ãƒã‚¤ãƒ³ã‚¿)ã‚’æŒ‡å®šã™ã‚‹ä»•æ§˜ã«å¤‰æ›´ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ãã“ã§ã€file_operationså‹ã®æ§‹é€ ä½“(ã¸ã®ãƒã‚¤ãƒ³ã‚¿)ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãƒ‰ãƒ©ã‚¤ãƒå´ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã€proc_opså‹ã®æ§‹é€ ä½“(ã¸ã®ãƒã‚¤ãƒ³ã‚¿)ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†å¤‰æ›´ã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ‰ãƒ©ã‚¤ãƒã«å®šç¾©ã•ã‚Œã¦ã„ãŸfile_operationså‹ã®æ§‹é€ ä½“ã®ãƒ¡ãƒ³ãƒåã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
- owner â†’ (å‰Šé™¤)
- read â†’ proc_read
- write â†’ proc_write
{%include secondintervalad.html %}
## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã®çµæœç”Ÿã˜ãŸå·®åˆ†ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚å¤‰æ•°åã«ã¤ã„ã¦ã¯å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ã€‚
```diff
diff --git a/nuc_led.c b/nuc_led.c
index c975f22..8a5ed78 100644
--- a/nuc_led.c
+++ b/nuc_led.c
@@ -443,10 +443,9 @@ static ssize_t acpi_proc_read(struct file *filp, char __user *buff,
         return ret;
 }

-static struct file_operations proc_acpi_operations = {
-        .owner    = THIS_MODULE,
-        .read     = acpi_proc_read,
-        .write    = acpi_proc_write,
+static struct proc_ops proc_acpi_operations = {
+        .proc_read     = acpi_proc_read,
+        .proc_write    = acpi_proc_write,
 };

 /* Init & unload */
```
## å‹•ä½œç¢ºèª
### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
ã‚‚ã¨ã‚‚ã¨ãƒ‰ãƒ©ã‚¤ãƒã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«ã¯dkmsã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ‰ãƒ©ã‚¤ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã«é–¢é€£ã™ã‚‹ä¿®æ­£ã‚’è¡Œã£ãŸå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
$ sudo make dkms-install
```
### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã®è¨­å®š
/etc/modules-load.dãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«nuc_led.confã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã‚’è¨˜è¿°ã—ã¾ã™ã€‚
```
nuc_led
```

è¨˜è¿°ãŒã§ããŸã‚‰ã€PCã‚’å†èµ·å‹•ã—ã¾ã™ã€‚
### procãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®èª­ã¿å‡ºã—
è©¦ã—ã«catã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦èª­ã¿å‡ºã—ã¦ã¿ã¾ã™ã€‚
```
$ cat /proc/acpi/nuc_led
Power LED Brightness: 100%
Power LED Blink/Fade: Always On (0x04)
Power LED Color: Amber (0x02)

Ring LED Brightness: 100%
Ring LED Blink/Fade: Always On (0x04)
Ring LED Color: White (0x07)
```
å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚ğŸ‘
{%include thirdintervalad.html %}
## ã¾ã¨ã‚
Linux kernelã®proc_fs.hã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã¨ã€proc_createé–¢æ•°ã®ç¬¬4å¼•æ•°ã®å‹ãŒå¤‰ã‚ã£ãŸã®ã¯Version 5.6-rc1ã‹ã‚‰ã®ã‚ˆã†ã§ã™ã€‚

æœ€è¿‘ã¯Linuxã®kernelã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚‚å°‘ãªããªã‚Šã¾ã—ãŸãŒã€æ™‚ã€…ãƒ‰ãƒ©ã‚¤ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸã‚Šã™ã‚‹ã¨ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æœ€æ–°ã®çŠ¶æ³ãŒå£é–“è¦‹ãˆãŸã‚Šã™ã‚‹ã®ã§ã€å‰²ã¨ãŠã™ã™ã‚ã§ã™ã€‚

ã“ã®è¨˜äº‹ã¯ä»¥ä¸Šã§ã™ã€‚
## å‚è€ƒæ–‡çŒ®
1. [Linux Kernel Driver for NUC LED Control](https://nucblog.net/2017/05/linux-kernel-driver-for-nuc-led-control/)
1. [\[PATCH 2/2\] proc: convert everything to "struct proc_ops"](https://lore.kernel.org/netdev/20191225172546.GB13378@avx2/)

## ãƒªãƒ³ã‚¯
{% include pagelink.md %}

{% include fourthintervalad.html %}
